<!-- About Add/Edit Content Fragment (不含 html/head/body) -->
<div class="admin-card">
    <h2 class="mb-4" id="formTitle">新增關於我們</h2>
    
    <!-- RWD Form - 全寬單欄 -->
    <form id="aboutForm">
        <input type="hidden" id="aboutId" />
        
        <div class="row g-3">
            <div class="col-12">
                <div class="mb-3">
                    <label class="form-label fw-bold">標題</label>
                    <input type="text" class="form-control" id="aboutTitle">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">副標題</label>
                    <input type="text" class="form-control" id="aboutSubtitle">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">描述 (支援 Markdown)</label>
                    <textarea id="aboutDescription"></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">聯絡 Email</label>
                    <input type="email" class="form-control" id="aboutEmail">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">
                        Values (JSON 格式)
                        <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="showJsonHelp()">
                            <i class="fas fa-question-circle"></i> 格式說明
                        </button>
                    </label>
                    <textarea class="form-control font-monospace" id="aboutValues" rows="12" placeholder='[{"icon":"Star","title":"Creativity First","description":"描述..."}]'></textarea>
                    <small class="text-muted">請輸入有效的 JSON 陣列</small>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="border-top pt-4 mt-4">
            <button type="submit" class="btn btn-primary px-4">
                <i class="fas fa-save me-2"></i> 儲存
            </button>
            <a href="#about/list" class="btn btn-secondary px-4 ms-2">
                <i class="fas fa-times me-2"></i> 取消
            </a>
        </div>
    </form>
</div>

<script>
window.pageInit = async function() {
    let isEditMode = false;
    let editingId = null;
    let descriptionEditor = null;

    // Initialize EasyMDE for description
    if (typeof EasyMDE !== 'undefined') {
        descriptionEditor = new EasyMDE({
            element: document.getElementById('aboutDescription'),
            spellChecker: false,
            placeholder: '請輸入描述...',
            status: false,
            minHeight: '200px',
            toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'image', '|', 'preview', 'side-by-side', 'fullscreen', '|', 'guide']
        });
    }

    // Check edit mode
    const hash = window.location.hash;
    const match = hash.match(/#about\/edit\/(\d+)/);
    if (match) {
        isEditMode = true;
        editingId = parseInt(match[1]);
        $('#formTitle').text('編輯關於我們');
        $('#pageHeader').text('編輯關於我們');
        await loadAbout(editingId);
    }

    async function loadAbout(id) {
        try {
            const about = await apiRequest(`/api/about/${id}`);
            $('#aboutId').val(about.id);
            $('#aboutTitle').val(about.title || '');
            $('#aboutSubtitle').val(about.subtitle || '');
            
            // Set description in EasyMDE
            if (descriptionEditor) {
                descriptionEditor.value(about.description || '');
            }
            
            $('#aboutEmail').val(about.contact_email || '');
            $('#aboutValues').val(JSON.stringify(about.values || [], null, 2));
        } catch (error) {
            showErrorToast('載入失敗: ' + error.message);
            window.location.hash = 'about/list';
        }
    }

    window.showJsonHelp = function() {
        const helpHtml = `
            <div class="modal fade" id="jsonHelpModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">JSON 格式說明</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>Values 欄位應為 JSON 陣列，每個項目包含：</p>
                            <pre class="bg-light p-3 rounded"><code>[
  {
    "icon": "Star",
    "title": "Creativity First",
    "description": "We believe in lively designs..."
  },
  {
    "icon": "Zap",
    "title": "Powered by AI",
    "description": "Leveraging cutting-edge..."
  }
]</code></pre>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $('#jsonHelpModal').remove();
        $('body').append(helpHtml);
        new bootstrap.Modal('#jsonHelpModal').show();
    };

    $('#aboutForm').submit(async function(e) {
        e.preventDefault();

        let values = [];
        try {
            const valuesText = $('#aboutValues').val().trim();
            if (valuesText) {
                values = JSON.parse(valuesText);
            }
        } catch {
            showErrorToast('Values JSON 格式錯誤！請檢查格式。');
            return;
        }

        const data = {
            title: $('#aboutTitle').val().trim() || null,
            subtitle: $('#aboutSubtitle').val().trim() || null,
            description: descriptionEditor ? descriptionEditor.value().trim() || null : null,
            contact_email: $('#aboutEmail').val().trim() || null,
            values: values
        };

        try {
            if (isEditMode) {
                await apiRequest(`/api/admin/about/${editingId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                showSuccessToast('更新成功！');
            } else {
                await apiRequest('/api/admin/about', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                showSuccessToast('新增成功！');
            }

            setTimeout(() => window.location.hash = 'about/list', 1000);
        } catch (error) {
            showErrorToast('儲存失敗: ' + error.message);
        }
    });
};
</script>

