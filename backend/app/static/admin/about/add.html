<!-- About Add/Edit Content Fragment (不含 html/head/body) -->
<div class="admin-card">
    <h2 class="mb-4" id="formTitle">新增關於我們</h2>
    
    <!-- RWD Form - 全寬單欄 -->
    <form id="aboutForm">
        <input type="hidden" id="aboutId" />
        
        <div class="row g-3">
            <div class="col-12">
                <div class="mb-3">
                    <label class="form-label fw-bold">標題</label>
                    <input type="text" class="form-control" id="aboutTitle">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">副標題</label>
                    <input type="text" class="form-control" id="aboutSubtitle">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">描述 (支援 Markdown)</label>
                    <textarea id="aboutDescription"></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">圖片</label>
                    <input type="hidden" id="aboutImage">
                    <div class="mb-2">
                        <label for="aboutImageFile" class="btn btn-primary">
                            <i class="fas fa-upload me-2"></i> 上傳圖片
                            <input type="file" id="aboutImageFile" accept="image/*" class="d-none">
                        </label>
                        <small class="text-muted ms-2">自動轉換為 WebP</small>
                    </div>
                    
                    <div id="imagePreview" class="mt-3 p-3 bg-light rounded border" style="display: none;">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1">
                                <img id="previewImg" class="img-fluid rounded" style="max-height: 200px;">
                            </div>
                            <button type="button" class="btn btn-sm btn-danger ms-2" id="deleteImageBtn" title="刪除圖片">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="small" id="imageInfo"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">聯絡 Email</label>
                    <input type="email" class="form-control" id="aboutEmail">
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="border-top pt-4 mt-4">
            <button type="submit" class="btn btn-primary px-4">
                <i class="fas fa-save me-2"></i> 儲存
            </button>
            <a href="#about/list" class="btn btn-secondary px-4 ms-2">
                <i class="fas fa-times me-2"></i> 取消
            </a>
        </div>
    </form>
</div>

<script>
// Ensure upload functions are available
if (typeof window.uploadImage !== 'function') {
    console.warn('Defining uploadImage as fallback');
    window.uploadImage = async function(file) {
        const formData = new FormData();
        formData.append('file', file);
        const response = await fetch('/api/admin/upload/image', {
            method: 'POST',
            credentials: 'include',
            body: formData
        });
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || '上傳失敗');
        }
        const result = await response.json();
        return result.filename;
    };
}

if (typeof window.getImageUrl !== 'function') {
    console.warn('Defining getImageUrl as fallback');
    window.getImageUrl = function(filename) {
        if (!filename) return '';
        if (filename.startsWith('http')) return filename;
        if (filename.startsWith('/static')) return filename;
        return `/static/uploads/${filename}`;
    };
}

window.pageInit = async function() {
    let isEditMode = false;
    let editingId = null;
    let descriptionEditor = null;
    
    console.log('About pageInit started');
    console.log('uploadImage type:', typeof window.uploadImage);
    console.log('getImageUrl type:', typeof window.getImageUrl);

    // Initialize EasyMDE for description
    if (typeof EasyMDE !== 'undefined') {
        descriptionEditor = new EasyMDE({
            element: document.getElementById('aboutDescription'),
            spellChecker: false,
            placeholder: '請輸入描述...',
            status: false,
            minHeight: '200px',
            toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'image', '|', 'preview', 'side-by-side', 'fullscreen', '|', 'guide']
        });
    }

    // Handle image upload
    $('#aboutImageFile').on('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        $('#imagePreview').show();
        $('#imageInfo').html('<div class="spinner-border spinner-border-sm me-2"></div>上傳中...');

        try {
            const filename = await window.uploadImage(file);
            
            // Save only filename (not path)
            $('#aboutImage').val(filename);
            
            // Display image preview with full URL
            const imageUrl = window.getImageUrl(filename);
            $('#previewImg').attr('src', imageUrl);
            
            // Show UUID info
            const uuid = filename.split('.')[0];
            $('#imageInfo').html(`<i class="fas fa-check-circle text-success"></i> 上傳成功！${uuid.substring(0, 12)}...`);
        } catch (error) {
            $('#imageInfo').html(`<i class="fas fa-times-circle text-danger"></i> ${error.message}`);
        }
    });

    // Handle image delete
    $('#deleteImageBtn').on('click', function() {
        if (!confirm('確定要刪除這張圖片嗎？')) return;
        
        // Clear input and hide preview
        $('#aboutImage').val('');
        $('#previewImg').attr('src', '');
        $('#imagePreview').hide();
        $('#imageInfo').html('');
        $('#aboutImageFile').val(''); // Reset file input
        
        if (typeof showSuccessToast === 'function') {
            showSuccessToast('圖片已移除');
        }
    });

    // Check edit mode
    const hash = window.location.hash;
    const match = hash.match(/#about\/edit\/(\d+)/);
    if (match) {
        isEditMode = true;
        editingId = parseInt(match[1]);
        $('#formTitle').text('編輯關於我們');
        $('#pageHeader').text('編輯關於我們');
        await loadAbout(editingId);
    }

    async function loadAbout(id) {
        try {
            const about = await apiRequest(`/api/about/${id}`);
            $('#aboutId').val(about.id);
            $('#aboutTitle').val(about.title || '');
            $('#aboutSubtitle').val(about.subtitle || '');
            
            // Set description in EasyMDE
            if (descriptionEditor) {
                descriptionEditor.value(about.description || '');
            }
            
            $('#aboutEmail').val(about.contact_email || '');
        } catch (error) {
            showErrorToast('載入失敗: ' + error.message);
            window.location.hash = 'about/list';
        }
    }

    $('#aboutForm').submit(async function(e) {
        e.preventDefault();

        const data = {
            title: $('#aboutTitle').val().trim() || null,
            subtitle: $('#aboutSubtitle').val().trim() || null,
            description: descriptionEditor ? descriptionEditor.value().trim() || null : null,
            image: $('#aboutImage').val().trim() || null,
            contact_email: $('#aboutEmail').val().trim() || null
        };

        try {
            if (isEditMode) {
                await apiRequest(`/api/admin/about/${editingId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                showSuccessToast('更新成功！');
            } else {
                await apiRequest('/api/admin/about', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                showSuccessToast('新增成功！');
            }

            setTimeout(() => window.location.hash = 'about/list', 1000);
        } catch (error) {
            showErrorToast('儲存失敗: ' + error.message);
        }
    });
};
</script>

