<!-- News Add/Edit Content Fragment (不含 html/head/body) -->
<div class="admin-card">
    <h2 class="mb-4" id="formTitle">新增消息</h2>
    
    <!-- RWD Form - 兩欄佈局 -->
    <form id="newsForm">
        <input type="hidden" id="newsId" />
        
        <div class="row g-4">
            <!-- 全寬欄位 -->
            <div class="col-12">
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        標題 <span class="text-danger">*</span>
                    </label>
                    <input type="text" class="form-control" id="newsTitle" required>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">摘要 (支援 Markdown)</label>
                    <textarea id="newsExcerpt"></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">內容 (支援 Markdown)</label>
                    <textarea id="newsContent"></textarea>
                </div>
            </div>

            <!-- 繼續全寬欄位 -->
            <div class="col-12">
                <div class="mb-3">
                    <label class="form-label fw-bold">圖片</label>
                    <div class="input-group mb-2">
                        <input type="url" class="form-control" id="newsImage" placeholder="https://example.com/image.jpg">
                        <label for="newsImageFile" class="btn btn-outline-primary">
                            <i class="fas fa-upload"></i> 上傳
                            <input type="file" id="newsImageFile" accept="image/*" class="d-none">
                        </label>
                    </div>
                    <small class="text-muted">自動轉換為 WebP</small>
                    
                    <div id="imagePreview" class="mt-3 p-3 bg-light rounded border d-none">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1">
                                <img id="previewImg" class="img-fluid rounded" style="max-height: 200px;">
                            </div>
                            <button type="button" class="btn btn-sm btn-danger ms-2" id="deleteImageBtn" title="刪除圖片">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="small" id="imageInfo"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">日期</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-calendar"></i>
                        </span>
                        <input type="text" class="form-control" id="newsDate" placeholder="選擇日期...">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">作者</label>
                    <input type="text" class="form-control" id="newsAuthor">
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="border-top pt-4 mt-4">
            <button type="submit" class="btn btn-primary px-4">
                <i class="fas fa-save me-2"></i> 儲存
            </button>
            <a href="#news/list" class="btn btn-secondary px-4 ms-2">
                <i class="fas fa-times me-2"></i> 取消
            </a>
        </div>
    </form>
</div>

<script>
window.pageInit = async function() {
    let isEditMode = false;
    let editingId = null;
    let excerptEditor = null;
    let contentEditor = null;

    // Initialize Flatpickr for date
    if (typeof flatpickr !== 'undefined') {
        flatpickr('#newsDate', {
            locale: flatpickr.l10ns.zh_tw || flatpickr.l10ns.default,
            dateFormat: 'Y-m-d',
            allowInput: true,
            clickOpens: true
        });
    }

    // Initialize EasyMDE for excerpt
    if (typeof EasyMDE !== 'undefined') {
        excerptEditor = new EasyMDE({
            element: document.getElementById('newsExcerpt'),
            spellChecker: false,
            placeholder: '請輸入摘要...',
            status: false,
            minHeight: '120px',
            toolbar: ['bold', 'italic', '|', 'quote', '|', 'preview']
        });

        // Initialize EasyMDE for content
        contentEditor = new EasyMDE({
            element: document.getElementById('newsContent'),
            spellChecker: false,
            placeholder: '請輸入完整內容...',
            status: false,
            minHeight: '300px',
            toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'image', '|', 'preview', 'side-by-side', 'fullscreen', '|', 'guide']
        });
    }

    // Check edit mode
    const hash = window.location.hash;
    const match = hash.match(/#news\/edit\/(.+)/);
    if (match) {
        isEditMode = true;
        editingId = match[1];
        $('#formTitle').text('編輯消息');
        $('#pageHeader').text('編輯消息');
        await loadNews(editingId);
    }

    // Image upload
    $('#newsImageFile').change(async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        $('#imagePreview').removeClass('d-none');
        $('#imageInfo').html('<div class="spinner-border spinner-border-sm me-2"></div>上傳中...');

        try {
            const filename = await uploadImage(file);
            
            // Save only filename (not path)
            $('#newsImage').val(filename);
            
            // Display image preview with full URL
            const imageUrl = getImageUrl(filename);
            $('#previewImg').attr('src', imageUrl);
            
            // Show UUID info
            const uuid = filename.split('.')[0];
            $('#imageInfo').html(`<i class="fas fa-check-circle text-success"></i> 上傳成功！UUID7: ${uuid.substring(0, 12)}...`);
        } catch (error) {
            $('#imageInfo').html(`<i class="fas fa-times-circle text-danger"></i> ${error.message}`);
        }
    });

    // Handle image delete
    $('#deleteImageBtn').on('click', function() {
        if (!confirm('確定要刪除這張圖片嗎？')) return;
        
        // Clear input and hide preview
        $('#newsImage').val('');
        $('#previewImg').attr('src', '');
        $('#imagePreview').addClass('d-none');
        $('#imageInfo').html('');
        $('#newsImageFile').val(''); // Reset file input
        
        showSuccessToast('圖片已移除');
    });

    async function loadNews(id) {
        try {
            const news = await apiRequest(`/api/news/${id}`);
            $('#newsId').val(news.id);
            $('#newsTitle').val(news.title);
            
            // Set values in EasyMDE editors
            if (excerptEditor) {
                excerptEditor.value(news.excerpt || '');
            }
            if (contentEditor) {
                contentEditor.value(news.content || '');
            }
            
            const imageFilename = news.image_url || '';
            $('#newsImage').val(imageFilename);
            $('#newsDate').val(news.date || '');
            $('#newsAuthor').val(news.author || '');

            if (imageFilename) {
                $('#imagePreview').removeClass('d-none');
                $('#previewImg').attr('src', getImageUrl(imageFilename));
                $('#previewImg').attr('src', news.image_url);
                $('#imageInfo').text('當前圖片');
            }
        } catch (error) {
            showErrorToast('載入失敗: ' + error.message);
            window.location.hash = 'news/list';
        }
    }

    $('#newsForm').submit(async function(e) {
        e.preventDefault();

        const title = $('#newsTitle').val().trim();
        if (!title) {
            showErrorToast('請填寫標題');
            return;
        }

        let newsId = $('#newsId').val();
        if (!isEditMode) {
            newsId = `news-${Date.now().toString().slice(-8)}`;
        }

        const data = {
            id: newsId,
            title: title,
            excerpt: excerptEditor ? excerptEditor.value().trim() || null : null,
            content: contentEditor ? contentEditor.value().trim() || null : null,
            image_url: $('#newsImage').val().trim() || null,
            date: $('#newsDate').val() || null,
            author: $('#newsAuthor').val().trim() || null,
        };

        try {
            if (isEditMode) {
                await apiRequest(`/api/admin/news/${editingId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                showSuccessToast('更新成功！');
            } else {
                await apiRequest('/api/admin/news', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                showSuccessToast('新增成功！');
            }

            setTimeout(() => window.location.hash = 'news/list', 1000);
        } catch (error) {
            showErrorToast('儲存失敗: ' + error.message);
        }
    });
};
</script>

