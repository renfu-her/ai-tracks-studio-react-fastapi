<!-- News Add/Edit Content Fragment (不含 html/head/body) -->
<div class="admin-card">
    <h2 class="mb-4" id="formTitle">新增 News</h2>
    
    <!-- RWD Form - 兩欄佈局 -->
    <form id="newsForm">
        <input type="hidden" id="newsId" />
        
        <div class="row g-4">
            <!-- 左欄 -->
            <div class="col-12 col-lg-6">
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        標題 <span class="text-danger">*</span>
                    </label>
                    <input type="text" class="form-control" id="newsTitle" required>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">摘要</label>
                    <textarea class="form-control" id="newsExcerpt" rows="3"></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">內容</label>
                    <textarea class="form-control" id="newsContent" rows="8"></textarea>
                </div>
            </div>

            <!-- 右欄 -->
            <div class="col-12 col-lg-6">
                <div class="mb-3">
                    <label class="form-label fw-bold">圖片</label>
                    <div class="input-group mb-2">
                        <input type="url" class="form-control" id="newsImage" placeholder="https://example.com/image.jpg">
                        <label for="newsImageFile" class="btn btn-outline-primary">
                            <i class="fas fa-upload"></i> 上傳
                            <input type="file" id="newsImageFile" accept="image/*" class="d-none">
                        </label>
                    </div>
                    <small class="text-muted">自動轉換為 WebP</small>
                    
                    <div id="imagePreview" class="mt-3 p-3 bg-light rounded border d-none">
                        <img id="previewImg" class="img-fluid rounded" style="max-height: 200px;">
                        <div class="mt-2 small" id="imageInfo"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">日期</label>
                    <input type="date" class="form-control" id="newsDate">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">作者</label>
                    <input type="text" class="form-control" id="newsAuthor">
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="border-top pt-4 mt-4">
            <button type="submit" class="btn btn-primary px-4">
                <i class="fas fa-save me-2"></i> 儲存
            </button>
            <a href="#news/list" class="btn btn-secondary px-4 ms-2">
                <i class="fas fa-times me-2"></i> 取消
            </a>
        </div>
    </form>
</div>

<script>
window.pageInit = async function() {
    let isEditMode = false;
    let editingId = null;

    // Check edit mode
    const hash = window.location.hash;
    const match = hash.match(/#news\/edit\/(.+)/);
    if (match) {
        isEditMode = true;
        editingId = match[1];
        $('#formTitle').text('編輯 News');
        $('#pageHeader').text('編輯 News');
        await loadNews(editingId);
    }

    // Image upload
    $('#newsImageFile').change(async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        $('#imagePreview').removeClass('d-none');
        $('#imageInfo').html('<div class="spinner-border spinner-border-sm me-2"></div>上傳中...');

        try {
            const formData = new FormData();
            formData.append('file', file);

            const result = await $.ajax({
                url: '/api/admin/upload/image',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                xhrFields: { withCredentials: true }
            });

            $('#newsImage').val(result.url);
            $('#previewImg').attr('src', result.url);
            $('#imageInfo').html(`<i class="fas fa-check-circle text-success"></i> 上傳成功！WebP ${(result.size/1024).toFixed(2)} KB`);
        } catch (error) {
            $('#imageInfo').html(`<i class="fas fa-times-circle text-danger"></i> 上傳失敗`);
        }
    });

    async function loadNews(id) {
        try {
            const news = await apiRequest(`/api/news/${id}`);
            $('#newsId').val(news.id);
            $('#newsTitle').val(news.title);
            $('#newsExcerpt').val(news.excerpt || '');
            $('#newsContent').val(news.content || '');
            $('#newsImage').val(news.image_url || '');
            $('#newsDate').val(news.date || '');
            $('#newsAuthor').val(news.author || '');

            if (news.image_url) {
                $('#imagePreview').removeClass('d-none');
                $('#previewImg').attr('src', news.image_url);
                $('#imageInfo').text('當前圖片');
            }
        } catch (error) {
            showErrorToast('載入失敗: ' + error.message);
            window.location.hash = 'news/list';
        }
    }

    $('#newsForm').submit(async function(e) {
        e.preventDefault();

        const title = $('#newsTitle').val().trim();
        if (!title) {
            showErrorToast('請填寫標題');
            return;
        }

        let newsId = $('#newsId').val();
        if (!isEditMode) {
            newsId = `news-${Date.now().toString().slice(-8)}`;
        }

        const data = {
            id: newsId,
            title: title,
            excerpt: $('#newsExcerpt').val().trim() || null,
            content: $('#newsContent').val().trim() || null,
            image_url: $('#newsImage').val().trim() || null,
            date: $('#newsDate').val() || null,
            author: $('#newsAuthor').val().trim() || null,
        };

        try {
            if (isEditMode) {
                await apiRequest(`/api/admin/news/${editingId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                showSuccessToast('更新成功！');
            } else {
                await apiRequest('/api/admin/news', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                showSuccessToast('新增成功！');
            }

            setTimeout(() => window.location.hash = 'news/list', 1000);
        } catch (error) {
            showErrorToast('儲存失敗: ' + error.message);
        }
    });
};
</script>

