<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">News ç®¡ç† - AI-Tracks Studio Admin</title>
    <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body>
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">AI-Tracks Studio</div>
                <div class="sidebar-subtitle">å¾Œå°ç®¡ç†ç³»çµ±</div>
            </div>
            <nav>
                <ul class="sidebar-nav">
                    <li class="nav-section expanded">
                        <div class="nav-section-title">
                            <span>ğŸ“¦ å…§å®¹ç®¡ç†</span>
                            <span class="nav-section-icon">â–¼</span>
                        </div>
                        <ul class="nav-section-items">
                            <li class="nav-item">
                                <a href="/backend/projects" class="nav-link">
                                    <span class="nav-icon">ğŸ®</span>
                                    <span>Projects ç®¡ç†</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="/backend/news" class="nav-link active">
                                    <span class="nav-icon">ğŸ“°</span>
                                    <span>News ç®¡ç†</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="/backend/about" class="nav-link">
                                    <span class="nav-icon">â„¹ï¸</span>
                                    <span>About ç®¡ç†</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1 class="header-title" id="headerTitle">æ–°å¢ News</h1>
                <div class="header-actions">
                    <span class="user-info" id="userInfo">è¼‰å…¥ä¸­...</span>
                    <button onclick="logout()" class="logout-btn">ç™»å‡º</button>
                </div>
            </div>

            <div class="card">
                <h2 id="formTitle" style="font-size: 24px; margin-bottom: 32px;">æ–°å¢ News</h2>
                
                <form id="newsForm" style="max-width: 800px;">
                    <input type="hidden" id="newsId" />
                    
                    <div class="form-row">
                        <label class="form-label">æ¨™é¡Œ <span style="color: #e53e3e;">*</span></label>
                        <input type="text" id="newsTitle" class="form-control" required />
                    </div>
                    <div class="form-row">
                        <label class="form-label">æ‘˜è¦</label>
                        <textarea id="newsExcerpt" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label">å…§å®¹</label>
                        <textarea id="newsContent" class="form-control" rows="8"></textarea>
                    </div>
                    <div class="form-row">
                        <label class="form-label">åœ–ç‰‡</label>
                        <div style="display: flex; gap: 12px; align-items: flex-start;">
                            <input type="url" id="newsImage" class="form-control" placeholder="https://example.com/image.jpg æˆ–ä¸Šå‚³åœ–ç‰‡" style="flex: 1;" />
                            <label for="newsImageFile" class="btn btn-primary" style="margin: 0; cursor: pointer;">
                                ğŸ“¤ ä¸Šå‚³åœ–ç‰‡
                                <input type="file" id="newsImageFile" accept="image/*" style="display: none;" onchange="uploadNewsImage(event)" />
                            </label>
                        </div>
                        <div id="newsImagePreview" style="margin-top: 12px; display: none;">
                            <img id="newsPreviewImg" style="max-width: 300px; max-height: 200px; border-radius: 8px; border: 2px solid #e2e8f0;" />
                            <div style="margin-top: 8px; color: #718096; font-size: 12px;" id="newsImageInfo"></div>
                        </div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">æ—¥æœŸ</label>
                        <input type="date" id="newsDate" class="form-control" />
                    </div>
                    <div class="form-row">
                        <label class="form-label">ä½œè€…</label>
                        <input type="text" id="newsAuthor" class="form-control" />
                    </div>
                    <div style="display: flex; gap: 16px; margin-top: 32px; padding-top: 24px; border-top: 1px solid #e2e8f0;">
                        <button type="submit" class="btn btn-primary" style="padding: 12px 32px;">ğŸ’¾ å„²å­˜</button>
                        <a href="/backend/news" class="btn" style="padding: 12px 32px; background: #e2e8f0; text-decoration: none; color: #2d3748;">å–æ¶ˆ</a>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script src="/static/js/admin.js"></script>
    <script>
        let isEditMode = false;
        let editingId = null;

        async function uploadNewsImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const preview = document.getElementById('newsImagePreview');
            const previewImg = document.getElementById('newsPreviewImg');
            const infoDiv = document.getElementById('newsImageInfo');
            
            preview.style.display = 'block';
            infoDiv.textContent = 'ä¸Šå‚³ä¸­...';
            previewImg.src = '';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/api/admin/upload/image', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ä¸Šå‚³å¤±æ•—');
                }
                
                const result = await response.json();
                document.getElementById('newsImage').value = result.url;
                previewImg.src = result.url;
                infoDiv.innerHTML = `âœ… ä¸Šå‚³æˆåŠŸï¼æ ¼å¼ï¼šWebPï¼Œå¤§å°ï¼š${(result.size / 1024).toFixed(2)} KB`;
                infoDiv.style.color = '#48bb78';
            } catch (error) {
                infoDiv.textContent = 'âŒ ' + error.message;
                infoDiv.style.color = '#e53e3e';
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const user = await checkAuth();
            if (user) {
                document.getElementById('userInfo').textContent = user.email;
                
                const urlParams = new URLSearchParams(window.location.search);
                editingId = urlParams.get('id');
                isEditMode = !!editingId;
                
                if (isEditMode) {
                    document.getElementById('pageTitle').textContent = 'ç·¨è¼¯ News';
                    document.getElementById('headerTitle').textContent = 'ç·¨è¼¯ News';
                    document.getElementById('formTitle').textContent = 'ç·¨è¼¯ News';
                    await loadNews(editingId);
                }
            }
        });

        async function loadNews(id) {
            try {
                const news = await apiRequest(`/api/news/${id}`);
                document.getElementById('newsId').value = news.id;
                document.getElementById('newsTitle').value = news.title;
                document.getElementById('newsExcerpt').value = news.excerpt || '';
                document.getElementById('newsContent').value = news.content || '';
                document.getElementById('newsImage').value = news.image_url || '';
                document.getElementById('newsDate').value = news.date || '';
                document.getElementById('newsAuthor').value = news.author || '';
                
                // Show image preview if exists
                if (news.image_url) {
                    const preview = document.getElementById('newsImagePreview');
                    const previewImg = document.getElementById('newsPreviewImg');
                    preview.style.display = 'block';
                    previewImg.src = news.image_url;
                    document.getElementById('newsImageInfo').textContent = 'ç•¶å‰åœ–ç‰‡';
                }
            } catch (error) {
                alert('è¼‰å…¥å¤±æ•—: ' + error.message);
                window.location.href = '/backend/news';
            }
        }

        document.getElementById('newsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('newsTitle').value.trim();
            if (!title) {
                alert('è«‹å¡«å¯«æ¨™é¡Œ');
                return;
            }
            
            // Auto-generate ID if not in edit mode
            let newsId = document.getElementById('newsId').value;
            if (!isEditMode) {
                const timestamp = Date.now().toString().slice(-8);
                newsId = `news-${timestamp}`;
            }
            
            const formData = {
                id: newsId,
                title: title,
                excerpt: document.getElementById('newsExcerpt').value.trim() || null,
                content: document.getElementById('newsContent').value.trim() || null,
                image_url: document.getElementById('newsImage').value.trim() || null,
                date: document.getElementById('newsDate').value || null,
                author: document.getElementById('newsAuthor').value.trim() || null,
            };
            
            try {
                if (isEditMode) {
                    await apiRequest(`/api/admin/news/${editingId}`, { method: 'PUT', body: JSON.stringify(formData) });
                    alert('âœ… æ›´æ–°æˆåŠŸï¼');
                } else {
                    await apiRequest('/api/admin/news', { method: 'POST', body: JSON.stringify(formData) });
                    alert('âœ… æ–°å¢æˆåŠŸï¼');
                }
                window.location.href = '/backend/news';
            } catch (error) {
                alert('âŒ å„²å­˜å¤±æ•—: ' + error.message);
            }
        });
    </script>
</body>
</html>

