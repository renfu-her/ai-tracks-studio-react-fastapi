<div class="row">
    <div class="col-lg-8">
        <div class="admin-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2 class="h5 mb-1">個人資料</h2>
                    <p class="text-muted mb-0">更新名稱或變更密碼，Email 僅供查看不可修改。</p>
                </div>
            </div>

            <form id="profileForm">
                <div class="mb-3">
                    <label class="form-label">Email（不可修改）</label>
                    <input type="email" class="form-control" id="profileEmail" disabled>
                </div>

                <div class="mb-3">
                    <label class="form-label">名稱</label>
                    <input type="text" class="form-control" id="profileName" placeholder="輸入顯示名稱">
                </div>

                <hr>

                <div class="mb-3">
                    <label class="form-label">目前密碼</label>
                    <input type="password" class="form-control" id="currentPassword" placeholder="變更密碼時必填">
                    <div class="form-text">僅在更改密碼時需要填寫。</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">新密碼</label>
                    <input type="password" class="form-control" id="newPassword" placeholder="輸入新密碼">
                    <div class="form-text">至少 6 碼，若不更改密碼可留空。</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">確認新密碼</label>
                    <input type="password" class="form-control" id="confirmPassword" placeholder="再次輸入新密碼">
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i> 儲存變更
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    async function loadProfile() {
        try {
            const profile = await apiRequest('/api/admin/profile', { method: 'GET' });
            if (profile) {
                $('#profileEmail').val(profile.email);
                $('#profileName').val(profile.name || '');
            }
        } catch (error) {
            console.error('Failed to load profile:', error);
            showErrorToast(error.message || '無法載入個人資料');
        }
    }

    async function saveProfile(event) {
        event.preventDefault();

        const name = $('#profileName').val().trim();
        const currentPassword = $('#currentPassword').val();
        const newPassword = $('#newPassword').val();
        const confirmPassword = $('#confirmPassword').val();

        if (newPassword || confirmPassword) {
            if (newPassword !== confirmPassword) {
                showErrorToast('新密碼與確認密碼不一致');
                return;
            }
            if (!currentPassword) {
                showErrorToast('變更密碼需要填寫目前密碼');
                return;
            }
            if (newPassword.length < 6) {
                showErrorToast('新密碼至少 6 碼');
                return;
            }
        }

        const payload = {};
        if (name) payload.name = name;
        if (newPassword) {
            payload.current_password = currentPassword;
            payload.new_password = newPassword;
        }

        if (!payload.name && !payload.new_password) {
            showErrorToast('請輸入要更新的名稱或新密碼');
            return;
        }

        try {
            await apiRequest('/api/admin/profile', {
                method: 'PUT',
                body: JSON.stringify(payload)
            });
            showSuccessToast('已更新個人資料');
            $('#currentPassword').val('');
            $('#newPassword').val('');
            $('#confirmPassword').val('');
            await loadProfile();
        } catch (error) {
            console.error('Failed to update profile:', error);
            showErrorToast(error.message || '更新失敗');
        }
    }

    window.pageInit = function() {
        loadProfile();
        $('#profileForm').on('submit', saveProfile);
    };
</script>

